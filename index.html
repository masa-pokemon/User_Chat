<!DOCTYPE html>
<html class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>JS Packer</title>
</head>
<body>
<h1>JS Packer</h1>
<p>pack JavaScript into a self-extracting PNG</p>
<h2>usage</h2>
<ol>
  <li>Paste your JS code into the textarea</li>
  <li>Press the pack button</li>
  <li>Download the result (either the dataURI or the image)</li>
  <li>Open it in your WebBrowser as a html file</li>
</ol>

<textarea id="input" style="display:block; width:100%; height:10em;">
var a = 1;
var b = 2;
alert( a + b );
</textarea>
<button id="button">pack the js into a png</button>
<hr>
<div id="result"></div>
<div id="debug"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pngjs/4.0.1/png.min.js"></script> <!-- PNGJSライブラリを追加 -->
<script>
var PNGUtil = {
  generateCRC: function( typeArray, dataArray ) {
    var i, l, crc = 0xffffffff, checksum;
    var array = [].concat(typeArray, dataArray);
    
    for (i = 0, l = array.length; i < l; i++) {
      crc = PNGUtil.CRCTable[(crc ^ array[i]) & 0xff] ^ (crc >>> 8);
    }
    
    checksum = crc ^ 0xffffffff;
    
    return [
      (checksum >>> 24) & 0xFF,
      (checksum >>> 16) & 0xFF,
      (checksum >>> 8) & 0xFF,
      checksum & 0xFF
    ];
  },

  generateChunk: function( type, data ) {
    var chunk = {
      length: [
        (data.length >>> 24) & 0xFF,
        (data.length >>> 16) & 0xFF,
        (data.length >>> 8) & 0xFF,
        data.length & 0xFF
      ],
      type: [type[0], type[1], type[2], type[3]],
      data: data,
      crc: null
    };
    
    chunk.crc = PNGUtil.generateCRC(chunk.type, chunk.data);
    return chunk;
  }
};

var convert = function(jscode) {
  var i, l;
  var input = String.fromCharCode(0x20) + jscode;
  var $canvas = document.createElement('canvas');
  var ctx = $canvas.getContext('2d');
  var pixels = input.length;
  var width = Math.ceil(Math.sqrt(input.length));
  var height = Math.floor(Math.sqrt(input.length));
  
  $canvas.width = width;
  $canvas.height = height;
  ctx.fillStyle = 'rgb( 32, 0, 0 )'; // 背景色を設定
  ctx.fillRect(0, 0, width, height);
  
  var imagedata = ctx.getImageData(0, 0, width, height);
  
  for (i = 0, l = pixels; i < l; i++) {
    var charCode = input.charCodeAt(i);
    imagedata.data[i * 4] = (charCode >> 16) & 0xFF; // R
    imagedata.data[i * 4 + 1] = (charCode >> 8) & 0xFF; // G
    imagedata.data[i * 4 + 2] = charCode & 0xFF; // B
    imagedata.data[i * 4 + 3] = 255; // A (透明度)
  }

  ctx.putImageData(imagedata, 0, 0);
  
  var dataUrl = $canvas.toDataURL('image/png');
  return dataUrl;
};

var doit = function() {
  var value = document.getElementById('input').value;
  var png = convert(value);

  var $result = document.getElementById('result');
  var $a = document.createElement('a');
  var $img = new Image();

  $result.innerHTML = '';
  $a.innerHTML = 'get the image as a html';
  $a.setAttribute('href', png);
  $a.setAttribute('download', 'png.html');
  $img.src = png;
  $result.appendChild($img);
  $result.appendChild($a);
};

document.getElementById('button').addEventListener('click', doit);
</script>

</body>
</html>
